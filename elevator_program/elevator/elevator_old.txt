func (e *Elevator) ElevatorStateMachine() {
	var d elevio.MotorDirection = elevio.MD_Up


	if e.currentFloor == e.targetFloor {
			fmt.Println("at target floor") // DB
			e.ClearFloor(e.currentFloor)
			e.ClearButtonLamp(e.currentFloor)

			if e.state == ES_Uninitialized {
				e.state = ES_Idle
			}
		}

	if e.state != ES_Uninitialized {
		nextTarget := e.GetNextTargetFloor()

		if nextTarget.Floor == -1 {
			e.state = ES_Idle
			d = elevio.MD_Stop
		} else {
			e.targetFloor = nextTarget.Floor
			e.state = ES_Moving
			
			if nextTarget.Floor == e.currentFloor {
				switch nextTarget.Button {
				case elevio.BT_HallUp:
					e.lastMovingDir = elevio.MD_Up
				case elevio.BT_HallDown:
					e.lastMovingDir = elevio.MD_Down
					}
			}
		}
	}

	d = e.GetMotion()
	fmt.Println("motor is now:", d) // DB
	if d != elevio.MD_Stop {
		e.lastMovingDir = d
	}
	elevio.SetMotorDirection(d)
	
	fmt.Println(e) // DB
}

func (e *Elevator) RunElevatorProgram(port string, id int, numFloors int, initTargetFloor int) {
	// numFloors := 4

	// "localhost:15657"
    elevio.Init("localhost:" + port, numFloors)
    
    // var d elevio.MotorDirection = elevio.MD_Up

    drv_buttons := make(chan elevio.ButtonEvent)
    drv_floors  := make(chan int)
    drv_obstr   := make(chan bool)
    drv_stop    := make(chan bool)    
    
    go elevio.PollButtons(drv_buttons)
    go elevio.PollFloorSensor(drv_floors)
    go elevio.PollObstructionSwitch(drv_obstr)
    go elevio.PollStopButton(drv_stop)

	e.InitElevator(id, numFloors, initTargetFloor)
    go e.ElevatorStateMachine()
    
    for {
        select {
        case btn := <- drv_buttons:

            // fmt.Printf("%+v\n", btn) // DB
			e.floorRequests[btn.Floor][btn.Button] = true
            elevio.SetButtonLamp(btn.Button, btn.Floor, true)

			if e.state == ES_Idle { e.state = ES_Moving }
            
        case pos := <- drv_floors:
			if pos == -1 { continue }

			e.currentFloor = pos
            
        case a := <- drv_obstr:
            fmt.Printf("%+v\n", a) // DB
            // if a {
            //     elevio.SetMotorDirection(elevio.MD_Stop)
            // } else {
            //     elevio.SetMotorDirection(d)
            // }
            
        case a := <- drv_stop:
            fmt.Printf("%+v\n", a) // DB
            // for f := 0; f < numFloors; f++ {
            //     for b := elevio.ButtonType(0); b < 3; b++ {
            //         elevio.SetButtonLamp(b, f, false)
            //     }
            // }
        }

		e.ElevatorStateMachine() // TODO not really a state machine ... might become one later
    }    
}